除了自建l2tp（参考之前的博客记录），另一种局域网服务器实现上网的方式是：找到另外一台常年开机的主机作为代理服务器提供上公网的服务。

这里A(内网IP172.19.58.202\系统CentOS7.4)为只有局域网络的服务器，B(内网IP172.19.58.201\系统CentOS7.4)为可以上公网的主机

### 1. 配置A代理

该步骤比较简单，直接配置环境变量即可。可以在/etc/profile下配置，这边采用在/etc/profile.d文件夹下配置环境变量。
```shell
#cd到/etc/profile.d/目录下
#新建proxy.sh，命名无所谓
[root@ali2 /] cd /etc/profile.d/
[root@ali2 profile.d] vi proxy.sh
```

proxy.sh里面内容：

```shell
#IP为要连接的代理服务器B，端口是要代理的端口，如下的意思该服务器要通过172.19.58.201服务器的端口10991的代理来访问公网
export http_proxy=http://172.19.58.201:10991
#如果要设置https代理，应该添加如下配置，暂未尝试过
#export https_proxy=http://172.19.58.201:10991
#设置不代理的IP或者网址，如下配置，这些请求不会被代理，不支持模糊匹配
export no_proxy="127.0.0.1, localhost, 172.19.58.202，172.19.58.201"
```

然后source /etc/profile，再使用指令echo $http_proxy，如果能打印出相关代理信息说明操作成功。

```shell
[root@ali2 profile.d] echo $http_proxy
http://172.19.58.201:10991
```



### 2. 主机B安装代理

#### 2.1 使用squid

```shell
#安装squid，这里采用yum的安装方式
[root@ali1 ~] yum install -y squid
#cd到配置文件目录下
[root@ali1 ~] cd  /etc/squid/
#备份原始配置文件
[root@ali1 ~] cp squid.conf squid.conf_bak
#修改配置文件
[root@ali1 squid]# vi squid.conf
```

squid.conf配置文件如下:

```shell
#将http_access deny all注释修改为http_access allow all
#http_access deny all
http_access allow all
# 修改端口为代理的端口
http_port 10991
```

启动

```shell

#检查语法是否错误
[root@ali1 squid] squid -k parse
#初始化缓存空间
[root@ali1 squid] squid -z
[root@ali1 squid] 2018/12/05 13:58:56 kid1| Set Current Directory to /var/spool/squid
2018/12/05 13:58:56 kid1| Creating missing swap directories
2018/12/13:58:56 kid1| No cache_dir stores are configured.
#启动squid
[root@ali1 squid] service squid start
Redirecting to /bin/systemctl start squid.service
#检查端口是否开启成功
[root@ali1 squid]# netstat -an | grep 10991
tcp6       0      0 :::10991                :::*                    LISTEN     
```

#### 2.2 使用nginx



参考: [局域网服务器如何设置代理访问公网_y1006597541的博客-CSDN博客_内网代理服务器上外网](https://blog.csdn.net/y1006597541/article/details/100152435)

